<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Creator Performance Dashboard | Creative Swop</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'brand-purple': '#6B21A8',
                        'brand-purple-dark': '#581C87',
                        'brand-red': '#DC2626',
                        'brand-green': '#059669',
                        'brand-amber': '#D97706',
                        'brand-blue': '#2563EB',
                    }
                }
            }
        }
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap');
        body { font-family: 'Inter', sans-serif; }
        
        .tooltip-trigger {
            position: relative;
            cursor: help;
        }
        
        .tooltip-content {
            display: none;
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            margin-bottom: 8px;
            padding: 8px 12px;
            background: #27272a; /* zinc-800 */
            color: white;
            border: 1px solid #3f3f46; /* zinc-700 */
            border-radius: 6px;
            font-size: 12px;
            white-space: nowrap;
            z-index: 1000;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
        }
        
        .tooltip-trigger:hover .tooltip-content {
            display: block;
        }
        
        /* Mobile responsive table */
        @media (max-width: 768px) {
            .content-table thead {
                display: none;
            }
            
            .content-table tr {
                display: block;
                margin-bottom: 1rem;
                border: 1px solid #27272a; /* zinc-800 */
                border-radius: 0.5rem;
                padding: 1rem;
            }
            
            .content-table td {
                display: flex;
                justify-content: space-between;
                align-items: center;
                padding: 0.5rem 0;
                border-bottom: 1px solid #27272a; /* zinc-800 */
            }
            
            .content-table td:last-child {
                border-bottom: none;
            }
            
            .content-table td::before {
                content: attr(data-label);
                font-weight: 600;
                color: #a1a1aa; /* zinc-400 */
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
            }
        }
        
        .tab-active {
            background: #6B21A8;
            color: white;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
        }
        
        /* Custom scrollbar for dark mode */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #18181b; 
        }
        ::-webkit-scrollbar-thumb {
            background: #3f3f46; 
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #52525b; 
        }
    </style>
</head>
<body class="bg-zinc-950 text-white">
    
    <header class="sticky top-0 z-50 bg-zinc-900 border-b border-zinc-800">
        <div class="container mx-auto px-6 py-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-8">
                    <div class="text-2xl font-bold text-brand-purple">CREATIVE SWOP</div>
                    <nav class="hidden md:flex space-x-6 text-sm">
                        <a href="/creator" class="text-zinc-400 hover:text-white transition-colors">Opportunities</a>
                        <a href="/my_campaign" class="text-zinc-400 hover:text-white transition-colors">My Campaign</a>
                        <a href="#" class="text-brand-purple font-medium">Analytics</a>
                        <a href="/settings" class="text-zinc-400 hover:text-white transition-colors">Settings</a>
                    </nav>
                </div>
                
                <button class="md:hidden text-zinc-400 hover:text-white" onclick="toggleMobileMenu()">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
                    </svg>
                </button>
            </div>
        </div>

        <div id="mobileMenu" class="md:hidden mt-4 border-t border-zinc-800 pt-4 hidden">
            <div class="space-y-2 px-6 pb-4">
                <a href="/creator" class="block py-2 text-zinc-400 hover:text-white">Opportunities</a>
                <a href="/my_campaign" class="block py-2 text-zinc-400 hover:text-white">My Campaign</a>
                <a href="/analytics" class="block py-2 text-brand-purple font-medium">Analytics</a>
            </div>
        </div>
    </header>

    <main class="container mx-auto px-6 py-8">
        <div class="mb-8">
            <h1 class="text-3xl font-bold mb-2 text-white">Creator Performance Dashboard</h1>
            <p class="text-zinc-400 mb-6">Track your earnings and content performance across all campaigns</p>
            
            <div class="flex space-x-1 bg-zinc-800 rounded-lg p-1 w-fit border border-zinc-700">
                <button id="tabContent" class="px-4 py-2 rounded-md tab-active transition-colors font-medium" onclick="switchTab('content')">
                    Content Performance
                </button>
                <button id="tabAffiliate" class="px-4 py-2 rounded-md text-zinc-400 hover:text-white transition-colors font-medium" onclick="switchTab('affiliate')">
                    Affiliate Campaigns
                </button>
            </div>
        </div>

        <div class="stats-grid mb-8">
            <div class="bg-zinc-900 rounded-2xl shadow-sm border border-zinc-800 p-6">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-sm font-medium text-zinc-400">Total Earnings (Lifetime)</h3>
                    <div class="tooltip-trigger">
                        <svg class="w-4 h-4 text-zinc-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                        <div class="tooltip-content">Cumulative earnings from all completed campaigns</div>
                    </div>
                </div>
                <div class="text-3xl font-bold text-brand-purple" id="totalEarnings">R 0</div>
                <div class="text-sm text-zinc-500 mt-1" id="earningsBreakdown"></div>
            </div>

            <div class="bg-zinc-900 rounded-2xl shadow-sm border border-zinc-800 p-6">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-sm font-medium text-zinc-400">Current Balance</h3>
                    <div class="tooltip-trigger">
                        <svg class="w-4 h-4 text-zinc-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                        <div class="tooltip-content">Available for immediate withdrawal</div>
                    </div>
                </div>
                <div class="text-3xl font-bold text-brand-green" id="currentBalance">R 0</div>
                <button id="payoutBtn" class="mt-4 w-full py-2 bg-brand-purple text-white rounded-lg text-sm font-semibold hover:bg-brand-purple-dark transition-colors disabled:opacity-50 disabled:cursor-not-allowed">
                    Request Payout
                </button>
            </div>

            <div class="bg-zinc-900 rounded-2xl shadow-sm border border-zinc-800 p-6">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-sm font-medium text-zinc-400">Pending Earnings</h3>
                    <div class="tooltip-trigger">
                        <svg class="w-4 h-4 text-zinc-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                        <div class="tooltip-content">Earnings from active campaigns awaiting verification</div>
                    </div>
                </div>
                <div class="text-3xl font-bold text-brand-amber" id="pendingEarnings">R 0</div>
                <div class="text-sm text-zinc-500 mt-1" id="pendingBreakdown"></div>
            </div>

            <div class="bg-zinc-900 rounded-2xl shadow-sm border border-zinc-800 p-6">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-sm font-medium text-zinc-400">Average CPM</h3>
                    <div class="tooltip-trigger">
                        <svg class="w-4 h-4 text-zinc-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                        <div class="tooltip-content">Average earnings per 1,000 views across all campaigns</div>
                    </div>
                </div>
                <div class="text-3xl font-bold text-brand-blue" id="averageCPM">R 0</div>
                <div class="text-sm text-zinc-500 mt-1" id="cpmBreakdown"></div>
            </div>
        </div>

        <div id="contentSection">
            <div class="bg-zinc-900 rounded-2xl shadow-sm border border-zinc-800 p-6 mb-8">
                <div class="flex items-center justify-between mb-6">
                    <h3 class="text-lg font-semibold text-white">Earnings Trend</h3>
                    <div class="flex gap-2">
                        <select id="timeRange" class="px-4 py-2 bg-zinc-800 border border-zinc-700 rounded-lg text-sm text-white focus:outline-none focus:border-brand-purple">
                            <option value="30">Last 30 Days</option>
                            <option value="60">Last 60 Days</option>
                            <option value="90">Last 90 Days</option>
                        </select>
                        <button id="exportBtn" class="px-4 py-2 bg-green-700 text-white rounded-lg text-sm font-semibold hover:bg-green-600 transition-colors flex items-center gap-2">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                            </svg>
                            Export
                        </button>
                    </div>
                </div>
                <canvas id="earningsChart" height="80"></canvas>
            </div>

            <div class="bg-zinc-900 rounded-2xl shadow-sm border border-zinc-800 p-6">
                <div class="flex flex-col md:flex-row md:items-center justify-between mb-6">
                    <h3 class="text-lg font-semibold mb-4 md:mb-0 text-white">Post-by-Post Performance</h3>
                    <div class="flex flex-col md:flex-row gap-4">
                        <select id="platformFilter" class="px-4 py-2 bg-zinc-800 border border-zinc-700 rounded-lg text-sm text-white focus:outline-none focus:border-brand-purple">
                            <option value="">All Platforms</option>
                            <option value="TikTok">TikTok</option>
                            <option value="Instagram">Instagram</option>
                            <option value="Instagram Reels">Instagram Reels</option>
                            <option value="YouTube">YouTube</option>
                        </select>
                        <select id="campaignFilter" class="px-4 py-2 bg-zinc-800 border border-zinc-700 rounded-lg text-sm text-white focus:outline-none focus:border-brand-purple">
                            <option value="">All Campaigns</option>
                        </select>
                        <input 
                            type="text" 
                            id="searchContent" 
                            placeholder="Search posts..." 
                            class="px-4 py-2 bg-zinc-800 border border-zinc-700 rounded-lg text-sm text-white placeholder-zinc-500 focus:outline-none focus:border-brand-purple"
                        >
                    </div>
                </div>

                <div class="overflow-x-auto">
                    <table class="w-full content-table">
                        <thead>
                            <tr class="border-b border-zinc-800">
                                <th class="text-left py-3 px-4 text-sm font-semibold text-zinc-400">Campaign Title</th>
                                <th class="text-left py-3 px-4 text-sm font-semibold text-zinc-400">Post Title / Platform</th>
                                <th class="text-left py-3 px-4 text-sm font-semibold text-zinc-400">Link</th>
                                <th class="text-right py-3 px-4 text-sm font-semibold text-zinc-400">Total Views</th>
                                <th class="text-right py-3 px-4 text-sm font-semibold text-zinc-400">Total Interactions</th>
                                <th class="text-right py-3 px-4 text-sm font-semibold text-zinc-400">Engagement Rate</th>
                                <th class="text-right py-3 px-4 text-sm font-semibold text-zinc-400">Earnings</th>
                                <th class="text-center py-3 px-4 text-sm font-semibold text-zinc-400">Status</th>
                            </tr>
                        </thead>
                        <tbody id="contentTable">
                            </tbody>
                    </table>
                </div>
                
                <div class="flex items-center justify-between mt-6">
                    <div class="text-sm text-zinc-400" id="paginationInfo">Showing 0 posts</div>
                    <div class="flex gap-2">
                        <button id="prevPage" class="px-4 py-2 border border-zinc-700 bg-zinc-800 text-white rounded-lg text-sm hover:bg-zinc-700 transition-colors disabled:opacity-50 disabled:hover:bg-zinc-800" disabled>
                            Previous
                        </button>
                        <button id="nextPage" class="px-4 py-2 border border-zinc-700 bg-zinc-800 text-white rounded-lg text-sm hover:bg-zinc-700 transition-colors disabled:opacity-50 disabled:hover:bg-zinc-800" disabled>
                            Next
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <div id="affiliateSection" class="hidden">
            <div class="stats-grid mb-8">
                <div class="bg-zinc-900 rounded-2xl shadow-sm border border-zinc-800 p-6">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-sm font-medium text-zinc-400">Affiliate Earnings</h3>
                        <div class="tooltip-trigger">
                            <svg class="w-4 h-4 text-zinc-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                            <div class="tooltip-content">Total earnings from affiliate campaigns</div>
                        </div>
                    </div>
                    <div class="text-3xl font-bold text-brand-purple" id="affiliateEarnings">R 0</div>
                    <div class="text-sm text-zinc-500 mt-1" id="affiliateEarningsBreakdown"></div>
                </div>

                <div class="bg-zinc-900 rounded-2xl shadow-sm border border-zinc-800 p-6">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-sm font-medium text-zinc-400">Active Campaigns</h3>
                        <div class="tooltip-trigger">
                            <svg class="w-4 h-4 text-zinc-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                            <div class="tooltip-content">Number of active affiliate campaigns</div>
                        </div>
                    </div>
                    <div class="text-3xl font-bold text-brand-blue" id="activeAffiliateCampaigns">0</div>
                    <div class="text-sm text-zinc-500 mt-1">Live campaigns</div>
                </div>

                <div class="bg-zinc-900 rounded-2xl shadow-sm border border-zinc-800 p-6">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-sm font-medium text-zinc-400">Total Potential conversions</h3>
                        <div class="tooltip-trigger">
                            <svg class="w-4 h-4 text-zinc-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                            <div class="tooltip-content">Total Potential conversions from your affiliate links</div>
                        </div>
                    </div>
                    <div class="text-3xl font-bold text-brand-green" id="totalConversions">0</div>
                    <div class="text-sm text-zinc-500 mt-1">All-time potential conversions</div>
                </div>

                <div class="bg-zinc-900 rounded-2xl shadow-sm border border-zinc-800 p-6">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-sm font-medium text-zinc-400">Avg Commission</h3>
                        <div class="tooltip-trigger">
                            <svg class="w-4 h-4 text-zinc-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                            <div class="tooltip-content">Average commission per potential conversion</div>
                        </div>
                    </div>
                    <div class="text-3xl font-bold text-brand-amber" id="averageCommission">R 0</div>
                    <div class="text-sm text-zinc-500 mt-1">Per Potential Conversion</div>
                </div>
            </div>

            <div class="bg-zinc-900 rounded-2xl shadow-sm border border-zinc-800 p-6">
                <div class="flex flex-col md:flex-row md:items-center justify-between mb-6">
                    <h3 class="text-lg font-semibold mb-4 md:mb-0 text-white">My Affiliate Campaigns</h3>
                    <div class="flex gap-2">
                        <button onclick="loadLiveAffiliateCampaigns()" class="px-4 py-2 bg-brand-purple text-white rounded-lg text-sm font-semibold hover:bg-brand-purple-dark transition-colors flex items-center gap-2">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                            </svg>
                            Find New Campaigns
                        </button>
                    </div>
                </div>

                <div class="overflow-x-auto">
                    <table class="w-full content-table">
                        <thead>
                            <tr class="border-b border-zinc-800">
                                <th class="text-left py-3 px-4 text-sm font-semibold text-zinc-400">Product & Brand</th>
                                <th class="text-left py-3 px-4 text-sm font-semibold text-zinc-400">Affiliate Code</th>
                                <th class="text-left py-3 px-4 text-sm font-semibold text-zinc-400">Commission</th>
                                <th class="text-right py-3 px-4 text-sm font-semibold text-zinc-400">potential conversions</th>
                                <th class="text-right py-3 px-4 text-sm font-semibold text-zinc-400">Total Earnings</th>
                                <th class="text-center py-3 px-4 text-sm font-semibold text-zinc-400">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="affiliateTable">
                            </tbody>
                    </table>
                </div>
                
                <div class="text-center py-8 text-zinc-500" id="affiliateEmptyState">
                    <svg class="w-16 h-16 mx-auto text-zinc-700 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                    <p class="text-lg font-medium text-zinc-400">No affiliate campaigns yet</p>
                    <p class="text-sm mt-1 text-zinc-500">Join affiliate campaigns to start earning commissions</p>
                    <button onclick="loadLiveAffiliateCampaigns()" class="mt-4 px-6 py-2 bg-brand-purple text-white rounded-lg font-semibold hover:bg-brand-purple-dark transition-colors">
                        Browse Available Campaigns
                    </button>
                </div>
            </div>
        </div>
    </main>

    <div id="payoutModal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 hidden p-4">
        <div class="bg-zinc-900 rounded-lg max-w-3xl w-full max-h-[80vh] overflow-hidden border border-zinc-800">
            <div class="flex items-center justify-between p-6 border-b border-zinc-800">
                <h3 class="text-xl font-semibold text-white">Payout History</h3>
                <button onclick="closePayoutModal()" class="text-zinc-400 hover:text-white transition-colors">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
            <div class="p-6 overflow-y-auto max-h-[60vh]">
                <table class="w-full">
                    <thead>
                        <tr class="border-b border-zinc-800">
                            <th class="text-left py-3 px-4 text-sm font-semibold text-zinc-400">Date</th>
                            <th class="text-left py-3 px-4 text-sm font-semibold text-zinc-400">Description</th>
                            <th class="text-right py-3 px-4 text-sm font-semibold text-zinc-400">Amount</th>
                            <th class="text-center py-3 px-4 text-sm font-semibold text-zinc-400">Status</th>
                        </tr>
                    </thead>
                    <tbody id="payoutHistory">
                        </tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="affiliateCampaignsModal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 hidden p-4">
        <div class="bg-zinc-900 rounded-lg max-w-4xl w-full max-h-[80vh] overflow-hidden border border-zinc-800">
            <div class="flex items-center justify-between p-6 border-b border-zinc-800">
                <h3 class="text-xl font-semibold text-white">Available Affiliate Campaigns</h3>
                <button onclick="closeAffiliateCampaignsModal()" class="text-zinc-400 hover:text-white transition-colors">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
            <div class="p-6 overflow-y-auto max-h-[60vh]">
                <div id="liveAffiliateCampaigns">
                    </div>
            </div>
        </div>
    </div>

    <script>
let earningsChart = null;
let performanceData = null;
let affiliateData = null;
let currentPage = 1;
const postsPerPage = 10;
let currentTab = 'content';

// Fetch performance data
async function loadPerformanceData() {
    try {
        showLoadingState();
        
        // Fetch complete performance data
        const response = await fetch('/api/creator/analytics-data');
        const data = await response.json();
        
        if (data.error) {
            console.error('Error from server:', data.error);
            showErrorMessage('Unable to load analytics data. Please try again later.');
            return;
        }
        
        // Store performance data globally
        performanceData = data;
        
        // Update financial summary with proper total earnings
        updateFinancialSummary(data);
        
        // Load affiliate data
        await loadAffiliateData();
        
        if (currentTab === 'content') {
            updateEarningsChart();
            populateContentTable();
            populateCampaignFilter();
        } else {
            populateAffiliateTable();
        }
        
        hideLoadingState();
    } catch (error) {
        console.error('Error loading performance data:', error);
        showErrorMessage('Unable to load analytics data. Please check your connection.');
        hideLoadingState();
    }
}

function updateFinancialSummary(data) {
    const financials = data.financial_summary;
    const affiliateEarnings = affiliateData ? affiliateData.total_earnings : 0;
    
    // Calculate total earnings (content + affiliate)
    const totalEarnings = (financials.total_earnings || 0) + affiliateEarnings;
    
    document.getElementById('totalEarnings').textContent = formatCurrency(totalEarnings);
    document.getElementById('currentBalance').textContent = formatCurrency(financials.current_balance || 0);
    document.getElementById('pendingEarnings').textContent = formatCurrency(financials.pending_earnings || 0);
    document.getElementById('averageCPM').textContent = formatCurrency(financials.average_cpm || 0, true);
    
    // Update breakdowns
    document.getElementById('earningsBreakdown').textContent = 
        `R ${(financials.total_earnings || 0).toLocaleString('en-ZA', {minimumFractionDigits: 2})} content + R ${affiliateEarnings.toLocaleString('en-ZA', {minimumFractionDigits: 2})} affiliate`;
    
    document.getElementById('pendingBreakdown').textContent = 
        `${data.content_performance ? data.content_performance.filter(p => p.status === 'Under Review').length : 0} posts pending`;
    
    document.getElementById('cpmBreakdown').textContent = 
        `Based on ${data.content_performance ? data.content_performance.length : 0} posts`;
    
    // Enable/disable payout button based on balance
    const payoutBtn = document.getElementById('payoutBtn');
    if (financials.current_balance > 0) {
        payoutBtn.disabled = false;
        payoutBtn.textContent = `Request Payout (${formatCurrency(financials.current_balance)})`;
    } else {
        payoutBtn.disabled = true;
        payoutBtn.textContent = 'No Funds Available';
    }
}

async function loadAffiliateData() {
    try {
        const response = await fetch('/api/creator/affiliate-codes');
        const data = await response.json();
        
        affiliateData = {
            codes: data,
            total_earnings: data.reduce((sum, code) => sum + ((code.use_count || 0) * (code.flat_fee || 0)), 0),
            total_conversions: data.reduce((sum, code) => sum + (code.use_count || 0), 0),
            active_campaigns: data.length,
            average_commission: data.length > 0 ? 
                data.reduce((sum, code) => sum + (code.flat_fee || 0), 0) / data.length : 0
        };
        
        updateAffiliateSummary();
    } catch (error) {
        console.error('Error loading affiliate data:', error);
        affiliateData = {
            codes: [],
            total_earnings: 0,
            total_conversions: 0,
            active_campaigns: 0,
            average_commission: 0
        };
        updateAffiliateSummary();
    }
}

function updateAffiliateSummary() {
    document.getElementById('affiliateEarnings').textContent = formatCurrency(affiliateData.total_earnings);
    document.getElementById('activeAffiliateCampaigns').textContent = affiliateData.active_campaigns;
    document.getElementById('totalConversions').textContent = affiliateData.total_conversions.toLocaleString();
    document.getElementById('averageCommission').textContent = formatCurrency(affiliateData.average_commission, true);
    
    document.getElementById('affiliateEarningsBreakdown').textContent = 
        `${affiliateData.total_conversions} Potential conversions`;
}

function formatCurrency(amount, isCPM = false) {
    if (isCPM) {
        return `R ${parseFloat(amount).toFixed(2)}`;
    }
    return `R ${parseFloat(amount).toLocaleString('en-ZA', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
}

function showLoadingState() {
    const elements = [
        'totalEarnings', 'currentBalance', 'pendingEarnings', 'averageCPM',
        'affiliateEarnings', 'activeAffiliateCampaigns', 'totalConversions', 'averageCommission'
    ];
    
    elements.forEach(id => {
        const element = document.getElementById(id);
        if (element) {
            element.textContent = 'Loading...';
            element.classList.add('text-zinc-500');
        }
    });
    
    document.getElementById('payoutBtn').disabled = true;
    document.getElementById('payoutBtn').textContent = 'Loading...';
}

function hideLoadingState() {
    const elements = [
        'totalEarnings', 'currentBalance', 'pendingEarnings', 'averageCPM',
        'affiliateEarnings', 'activeAffiliateCampaigns', 'totalConversions', 'averageCommission'
    ];
    
    elements.forEach(id => {
        const element = document.getElementById(id);
        if (element) {
            element.classList.remove('text-zinc-500');
        }
    });
}

function switchTab(tab) {
    currentTab = tab;
    
    // Update tab styles
    document.getElementById('tabContent').classList.toggle('tab-active', tab === 'content');
    document.getElementById('tabContent').classList.toggle('text-zinc-400', tab !== 'content');
    document.getElementById('tabAffiliate').classList.toggle('tab-active', tab === 'affiliate');
    document.getElementById('tabAffiliate').classList.toggle('text-zinc-400', tab !== 'affiliate');
    
    // Show/hide sections
    document.getElementById('contentSection').classList.toggle('hidden', tab !== 'content');
    document.getElementById('affiliateSection').classList.toggle('hidden', tab !== 'affiliate');
    
    // Load data for the selected tab
    if (tab === 'affiliate' && affiliateData) {
        populateAffiliateTable();
    }
}

function showErrorMessage(message) {
    const tbody = document.getElementById('contentTable');
    tbody.innerHTML = `
        <tr>
            <td colspan="8" class="py-8 text-center text-red-400">
                <div class="flex flex-col items-center justify-center">
                    <svg class="w-12 h-12 text-red-500/50 mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L4.35 16.5c-.77.833.192 2.5 1.732 2.5z"></path>
                    </svg>
                    <span class="text-lg font-medium">${message}</span>
                    <button onclick="loadPerformanceData()" class="mt-2 px-4 py-2 bg-brand-purple text-white rounded-lg text-sm font-semibold hover:bg-brand-purple-dark transition-colors">
                        Try Again
                    </button>
                </div>
            </td>
        </tr>
    `;
}

function updateEarningsChart() {
    const ctx = document.getElementById('earningsChart').getContext('2d');
    
    if (earningsChart) {
        earningsChart.destroy();
    }
    
    // If no data, show empty state
    if (!performanceData.earnings_trend.dates.length || !performanceData.earnings_trend.amounts.length) {
        ctx.font = '16px Inter';
        ctx.fillStyle = '#71717a'; // zinc-500
        ctx.textAlign = 'center';
        ctx.fillText('No earnings data available', ctx.canvas.width / 2, ctx.canvas.height / 2);
        return;
    }
    
    earningsChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: performanceData.earnings_trend.dates,
            datasets: [{
                label: 'Earnings',
                data: performanceData.earnings_trend.amounts,
                borderColor: '#6B21A8',
                backgroundColor: 'rgba(107, 33, 168, 0.2)',
                borderWidth: 3,
                fill: true,
                tension: 0.4,
                pointBackgroundColor: '#6B21A8',
                pointBorderColor: '#18181b', // zinc-900
                pointBorderWidth: 2,
                pointRadius: 4,
                pointHoverRadius: 6
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            plugins: {
                legend: {
                    display: false
                },
                tooltip: {
                    mode: 'index',
                    intersect: false,
                    backgroundColor: '#27272a', // zinc-800
                    titleColor: '#fff',
                    bodyColor: '#e4e4e7', // zinc-200
                    borderColor: '#3f3f46', // zinc-700
                    borderWidth: 1,
                    callbacks: {
                        label: function(context) {
                            return `Earnings: R ${context.raw.toLocaleString('en-ZA', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
                        }
                    }
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    grid: {
                        color: '#27272a' // zinc-800
                    },
                    ticks: {
                        color: '#a1a1aa', // zinc-400
                        callback: function(value) {
                            return 'R ' + value.toLocaleString();
                        }
                    }
                },
                x: {
                    grid: {
                        display: false
                    },
                    ticks: {
                        color: '#a1a1aa' // zinc-400
                    }
                }
            }
        }
    });
}

function populateContentTable() {
    const tbody = document.getElementById('contentTable');
    const platformFilter = document.getElementById('platformFilter').value;
    const campaignFilter = document.getElementById('campaignFilter').value;
    const searchTerm = document.getElementById('searchContent').value.toLowerCase();
    
    // Filter content
    let filteredContent = performanceData.content_performance.filter(post => {
        const matchesPlatform = !platformFilter || post.platform === platformFilter;
        const matchesCampaign = !campaignFilter || post.campaign_id.toString() === campaignFilter;
        const matchesSearch = !searchTerm || 
            post.campaign_title.toLowerCase().includes(searchTerm) ||
            (post.post_title && post.post_title.toLowerCase().includes(searchTerm));
        
        return matchesPlatform && matchesCampaign && matchesSearch;
    });
    
    // Pagination
    const totalPages = Math.ceil(filteredContent.length / postsPerPage);
    const startIndex = (currentPage - 1) * postsPerPage;
    const endIndex = startIndex + postsPerPage;
    const paginatedContent = filteredContent.slice(startIndex, endIndex);
    
    // Update pagination info
    document.getElementById('paginationInfo').textContent = 
        `Showing ${startIndex + 1}-${Math.min(endIndex, filteredContent.length)} of ${filteredContent.length} posts`;
    
    // Update pagination buttons
    document.getElementById('prevPage').disabled = currentPage === 1;
    document.getElementById('nextPage').disabled = currentPage === totalPages || totalPages === 0;
    
    // Generate table rows
    if (paginatedContent.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="8" class="py-8 text-center text-zinc-500">
                    <div class="flex flex-col items-center justify-center">
                        <svg class="w-12 h-12 text-zinc-700 mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.172 16.172a4 4 0 015.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                        <span class="text-lg">No posts found</span>
                        <p class="text-sm text-zinc-500 mt-1">Try adjusting your filters or search terms</p>
                    </div>
                </td>
            </tr>
        `;
        return;
    }
    
    const tableHTML = paginatedContent.map(post => {
        const engagementRate = post.total_views > 0 ? 
            ((post.total_interactions / post.total_views) * 100).toFixed(2) : 0;
        
        return `
        <tr class="border-b border-zinc-800 hover:bg-zinc-800 transition-colors">
            <td class="py-4 px-4 text-zinc-200" data-label="Campaign Title">
                <a href="/my_campaign?campaign=${post.campaign_id}" class="text-brand-purple hover:text-brand-purple-dark font-medium">
                    ${post.campaign_title || 'Untitled Campaign'}
                </a>
            </td>
            <td class="py-4 px-4 text-zinc-300" data-label="Post / Platform">
                <div class="flex items-center gap-2">
                    <span class="font-medium">${post.post_title || 'Untitled Post'}</span>
                    <span class="px-2 py-1 bg-zinc-800 text-zinc-400 border border-zinc-700 rounded text-xs">${post.platform || 'Unknown'}</span>
                </div>
            </td>
            <td class="py-4 px-4" data-label="Link">
                <a href="${post.post_url}" target="_blank" class="text-brand-purple hover:text-brand-purple-dark inline-flex items-center gap-1">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"></path>
                    </svg>
                    View
                </a>
            </td>
            <td class="py-4 px-4 text-right font-semibold text-zinc-200" data-label="Total Views">${(post.total_views || 0).toLocaleString()}</td>
            <td class="py-4 px-4 text-right text-zinc-200" data-label="Total Interactions">${(post.total_interactions || 0).toLocaleString()}</td>
            <td class="py-4 px-4 text-right" data-label="Engagement Rate">
                <span class="font-semibold ${engagementRate > 5 ? 'text-green-500' : engagementRate > 2 ? 'text-amber-500' : 'text-red-500'}">
                    ${engagementRate}%
                </span>
            </td>
            <td class="py-4 px-4 text-right font-semibold text-brand-red" data-label="Earnings">${formatCurrency(post.earnings || 0)}</td>
            <td class="py-4 px-4 text-center" data-label="Status">
                <span class="px-3 py-1 rounded-full text-xs font-semibold ${getStatusClass(post.status)}">
                    ${post.status}
                </span>
            </td>
        </tr>
        `;
    }).join('');
    
    tbody.innerHTML = tableHTML;
}

function getStatusClass(status) {
    const statusMap = {
        'Tracked': 'bg-green-900/30 text-green-400 border border-green-800',
        'Payment Processed': 'bg-blue-900/30 text-blue-400 border border-blue-800',
        'Verified': 'bg-purple-900/30 text-purple-400 border border-purple-800',
        'Pending': 'bg-amber-900/30 text-amber-400 border border-amber-800',
        'Under Review': 'bg-zinc-800 text-zinc-300 border border-zinc-700',
        'Rejected': 'bg-red-900/30 text-red-400 border border-red-800'
    };
    return statusMap[status] || 'bg-zinc-800 text-zinc-300 border border-zinc-700';
}

function populateCampaignFilter() {
    const campaignFilter = document.getElementById('campaignFilter');
    
    // Clear existing options except "All Campaigns"
    while (campaignFilter.children.length > 1) {
        campaignFilter.removeChild(campaignFilter.lastChild);
    }
    
    // Get unique campaigns from performance data
    const campaigns = [...new Set(performanceData.content_performance.map(post => post.campaign_id))];
    
    campaigns.forEach(campaignId => {
        const campaign = performanceData.content_performance.find(p => p.campaign_id === campaignId);
        if (campaign) {
            const option = document.createElement('option');
            option.value = campaignId;
            option.textContent = campaign.campaign_title || `Campaign ${campaignId}`;
            campaignFilter.appendChild(option);
        }
    });
}

function populateAffiliateTable() {
    const tbody = document.getElementById('affiliateTable');
    const emptyState = document.getElementById('affiliateEmptyState');
    
    if (!affiliateData.codes || affiliateData.codes.length === 0) {
        tbody.innerHTML = '';
        emptyState.classList.remove('hidden');
        return;
    }
    
    emptyState.classList.add('hidden');
    
    const tableHTML = affiliateData.codes.map(code => {
        const totalEarnings = (code.use_count || 0) * (code.flat_fee || 0);
        const baseUrl = window.location.origin;
        const affiliateLink = `${baseUrl}/track/${code.affiliate_code}`;
        
        return `
        <tr class="border-b border-zinc-800 hover:bg-zinc-800 transition-colors">
            <td class="py-4 px-4" data-label="Product & Brand">
                <div>
                    <div class="font-medium text-white">${code.product_name || 'Unknown Product'}</div>
                    <div class="text-sm text-zinc-500">${code.brand || 'Unknown Brand'}</div>
                </div>
            </td>
            <td class="py-4 px-4" data-label="Affiliate Code">
                <div class="flex items-center gap-2">
                    <code class="bg-zinc-800 px-2 py-1 rounded text-sm font-mono text-zinc-300 border border-zinc-700">${code.affiliate_code}</code>
                    <button onclick="copyToClipboard('${affiliateLink}')" class="text-brand-purple hover:text-brand-purple-dark" title="Copy link">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"></path>
                        </svg>
                    </button>
                </div>
            </td>
            <td class="py-4 px-4" data-label="Commission">
                <span class="font-semibold text-brand-green">${formatCurrency(code.flat_fee || 0)}</span>
            </td>
            <td class="py-4 px-4 text-right font-semibold text-zinc-200" data-label="Conversions">${code.use_count || 0}</td>
            <td class="py-4 px-4 text-right font-semibold text-brand-red" data-label="Total Earnings">${formatCurrency(totalEarnings)}</td>
            <td class="py-4 px-4 text-center" data-label="Actions">
                <a href="${affiliateLink}" target="_blank" class="text-brand-purple hover:text-brand-purple-dark text-sm font-medium">
                    View Link
                </a>
            </td>
        </tr>
        `;
    }).join('');
    
    tbody.innerHTML = tableHTML;
}

function copyToClipboard(text) {
    navigator.clipboard.writeText(text).then(() => {
        // Show success message
        const toast = document.createElement('div');
        toast.className = 'fixed top-4 right-4 bg-green-700 text-white px-4 py-2 rounded-lg shadow-lg z-50';
        toast.textContent = 'Link copied to clipboard!';
        document.body.appendChild(toast);
        
        setTimeout(() => {
            document.body.removeChild(toast);
        }, 2000);
    });
}

async function loadLiveAffiliateCampaigns() {
    try {
        const response = await fetch('/api/affiliate-campaigns/live');
        const data = await response.json();
        
        const container = document.getElementById('liveAffiliateCampaigns');
        
        if (!data.campaigns || data.campaigns.length === 0) {
            container.innerHTML = `
                <div class="text-center py-8 text-zinc-500">
                    <p class="text-lg">No live affiliate campaigns available</p>
                    <p class="text-sm mt-1">Check back later for new opportunities</p>
                </div>
            `;
        } else {
            const campaignsHTML = data.campaigns.map(campaign => {
                const hasCode = affiliateData.codes.some(code => code.campaign_id === campaign.id);
                
                return `
                <div class="border border-zinc-800 bg-zinc-800/50 rounded-lg p-4 mb-4">
                    <div class="flex justify-between items-start mb-3">
                        <div>
                            <h4 class="font-semibold text-lg text-white">${campaign.product_name}</h4>
                            <p class="text-zinc-400">${campaign.brand}</p>
                        </div>
                        <span class="px-3 py-1 bg-green-900/30 text-green-400 border border-green-800 rounded-full text-xs font-semibold">
                            ${campaign.flat_fee ? formatCurrency(campaign.flat_fee) : 'R 0'} per potential conversion
                        </span>
                    </div>
                    <p class="text-sm text-zinc-300 mb-3">${campaign.product_description || 'No description available'}</p>
                    <div class="flex justify-between items-center">
                        <div class="text-sm text-zinc-500">
                            ${campaign.current_influencers || 0}/${campaign.max_influencers || 0} influencers joined
                        </div>
                        <button 
                            onclick="generateAffiliateCode(${campaign.id})" 
                            class="px-4 py-2 bg-brand-purple text-white rounded-lg text-sm font-semibold hover:bg-brand-purple-dark transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
                            ${hasCode ? 'disabled' : ''}
                        >
                            ${hasCode ? 'Already Joined' : 'Join Campaign'}
                        </button>
                    </div>
                </div>
                `;
            }).join('');
            
            container.innerHTML = campaignsHTML;
        }
        
        document.getElementById('affiliateCampaignsModal').classList.remove('hidden');
        document.body.style.overflow = 'hidden';
    } catch (error) {
        console.error('Error loading live affiliate campaigns:', error);
        alert('Error loading campaigns. Please try again.');
    }
}

async function generateAffiliateCode(campaignId) {
    try {
        const response = await fetch('/api/creator/generate-affiliate-code', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                campaign_id: campaignId
            })
        });
        
        const result = await response.json();
        
        if (response.ok) {
            alert('Successfully joined affiliate campaign! Your affiliate code has been generated.');
            closeAffiliateCampaignsModal();
            await loadAffiliateData();
            populateAffiliateTable();
        } else {
            alert('Error: ' + result.message);
        }
    } catch (error) {
        console.error('Error generating affiliate code:', error);
        alert('Error joining campaign. Please try again.');
    }
}

function closeAffiliateCampaignsModal() {
    document.getElementById('affiliateCampaignsModal').classList.add('hidden');
    document.body.style.overflow = 'auto';
}

function showPayoutModal() {
    // Populate payout history
    const tbody = document.getElementById('payoutHistory');
    
    if (!performanceData.payout_history || performanceData.payout_history.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="4" class="py-8 text-center text-zinc-500">
                    <div class="flex flex-col items-center justify-center">
                        <svg class="w-12 h-12 text-zinc-700 mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1"></path>
                        </svg>
                        <span class="text-lg">No payout history</span>
                        <p class="text-sm text-zinc-500 mt-1">Your payout requests will appear here</p>
                    </div>
                </td>
            </tr>
        `;
    } else {
        const historyHTML = performanceData.payout_history.map(payout => `
            <tr class="border-b border-zinc-800 hover:bg-zinc-800 text-zinc-300">
                <td class="py-3 px-4">${new Date(payout.date).toLocaleDateString('en-ZA')}</td>
                <td class="py-3 px-4">${payout.description || 'Payout'}</td>
                <td class="py-3 px-4 text-right font-semibold">${formatCurrency(payout.amount)}</td>
                <td class="py-3 px-4 text-center">
                    <span class="px-3 py-1 rounded-full text-xs font-semibold ${payout.status === 'Completed' ? 'bg-green-900/30 text-green-400 border border-green-800' : payout.status === 'Pending' ? 'bg-amber-900/30 text-amber-400 border border-amber-800' : 'bg-zinc-800 text-zinc-400 border border-zinc-700'}">
                        ${payout.status}
                    </span>
                </td>
            </tr>
        `).join('');
        
        tbody.innerHTML = historyHTML;
    }
    
    document.getElementById('payoutModal').classList.remove('hidden');
    document.body.style.overflow = 'hidden';
}

function closePayoutModal() {
    document.getElementById('payoutModal').classList.add('hidden');
    document.body.style.overflow = 'auto';
}

async function requestPayout() {
    const currentBalance = performanceData.financial_summary.current_balance;
    
    if (currentBalance <= 0) {
        alert('No funds available for payout');
        return;
    }
    
    if (!confirm(`Request payout of ${formatCurrency(currentBalance)}?`)) {
        return;
    }
    
    try {
        const response = await fetch('/api/creator/request-payout', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                amount: currentBalance
            })
        });
        
        const result = await response.json();
        
        if (response.ok) {
            alert('Payout request submitted successfully!');
            closePayoutModal();
            loadPerformanceData(); // Refresh data
        } else {
            alert('Error: ' + result.message);
        }
    } catch (error) {
        console.error('Payout request error:', error);
        alert('Error submitting payout request. Please try again.');
    }
}

function exportData() {
    if (!performanceData) {
        alert('No data available to export');
        return;
    }
    
    let csvContent = '';
    let filename = '';
    
    if (currentTab === 'content') {
        csvContent = [
            ['Campaign Title', 'Post Title', 'Platform', 'Total Views', 'Total Interactions', 'Engagement Rate', 'Earnings', 'Status', 'Posted Date'],
            ...performanceData.content_performance.map(post => {
                const engagementRate = post.total_views > 0 ? 
                    ((post.total_interactions / post.total_views) * 100).toFixed(2) : 0;
                
                return [
                    post.campaign_title,
                    post.post_title,
                    post.platform,
                    post.total_views,
                    post.total_interactions,
                    engagementRate,
                    post.earnings,
                    post.status,
                    post.posted_date
                ];
            })
        ].map(row => row.join(',')).join('\n');
        
        filename = `content_performance_${new Date().toISOString().split('T')[0]}.csv`;
    } else {
        csvContent = [
            ['Product Name', 'Brand', 'Affiliate Code', 'Commission', 'potential conversions', 'Total Earnings'],
            ...affiliateData.codes.map(code => {
                const totalEarnings = (code.use_count || 0) * (code.flat_fee || 0);
                return [
                    code.product_name,
                    code.brand,
                    code.affiliate_code,
                    code.flat_fee,
                    code.use_count,
                    totalEarnings
                ];
            })
        ].map(row => row.join(',')).join('\n');
        
        filename = `affiliate_performance_${new Date().toISOString().split('T')[0]}.csv`;
    }
    
    const blob = new Blob([csvContent], { type: 'text/csv' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = filename;
    a.click();
    window.URL.revokeObjectURL(url);
}

// Event listeners
document.getElementById('timeRange').addEventListener('change', function() {
    currentPage = 1;
    loadPerformanceData(); // Reload data with new time range
});

document.getElementById('platformFilter').addEventListener('change', function() {
    currentPage = 1;
    populateContentTable();
});

document.getElementById('campaignFilter').addEventListener('change', function() {
    currentPage = 1;
    populateContentTable();
});

document.getElementById('searchContent').addEventListener('input', function() {
    currentPage = 1;
    populateContentTable();
});

document.getElementById('prevPage').addEventListener('click', function() {
    if (currentPage > 1) {
        currentPage--;
        populateContentTable();
    }
});

document.getElementById('nextPage').addEventListener('click', function() {
    const totalPages = Math.ceil(
        performanceData.content_performance.length / postsPerPage
    );
    if (currentPage < totalPages) {
        currentPage++;
        populateContentTable();
    }
});

document.getElementById('payoutBtn').addEventListener('click', showPayoutModal);
document.getElementById('exportBtn').addEventListener('click', exportData);

// Initialize
document.addEventListener('DOMContentLoaded', function() {
    loadPerformanceData();
    
    // Auto-refresh data every 5 minutes
    setInterval(loadPerformanceData, 5 * 60 * 1000);
});

function toggleMobileMenu() {
    const mobileMenu = document.getElementById('mobileMenu');
    mobileMenu.classList.toggle('hidden');
}
    </script>
</body>
</html>
